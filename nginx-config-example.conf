# Store 静态资源服务 Nginx 配置示例
# 文件位置：/etc/nginx/sites-available/static-aipso

# 上游服务器（如果使用负载均衡）
upstream static_backend {
    least_conn;
    server 127.0.0.1:8080 weight=1;
    server 127.0.0.1:8081 weight=1;
    keepalive 32;
}

# HTTP服务器（重定向到HTTPS）
server {
    listen 80;
    listen [::]:80;
    server_name static.aip.so;

    # Let's Encrypt验证
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 重定向到HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS服务器
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name static.aip.so;

    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/static.aip.so/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/static.aip.so/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/static.aip.so/chain.pem;

    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # 静态资源根目录
    root /var/www/static;

    # 字符集
    charset utf-8;

    # 日志配置
    access_log /var/log/nginx/static-access.log combined;
    error_log /var/log/nginx/static-error.log warn;

    # 自定义日志格式（包含响应时间）
    log_format static_detailed '$remote_addr - $remote_user [$time_local] '
                               '"$request" $status $body_bytes_sent '
                               '"$http_referer" "$http_user_agent" '
                               'rt=$request_time uct="$upstream_connect_time" '
                               'uht="$upstream_header_time" urt="$upstream_response_time"';

    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types
        image/webp
        image/jpeg
        image/png
        image/gif
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss;

    # Brotli压缩（如果已安装）
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types image/webp image/jpeg image/png;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # CORS配置
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;

    # 处理OPTIONS预检请求
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type "text/plain; charset=utf-8";
        add_header Content-Length 0;
        return 204;
    }

    # 限流配置
    limit_req_zone $binary_remote_addr zone=static_limit:10m rate=50r/s;
    limit_req zone=static_limit burst=100 nodelay;

    # 限制连接数
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    limit_conn addr 10;

    # 禁止目录浏览
    autoindex off;

    # 隐藏Nginx版本
    server_tokens off;

    # 限制请求方法
    if ($request_method !~ ^(GET|HEAD|OPTIONS)$ ) {
        return 405;
    }

    # 防盗链（可选）
    # valid_referers none blocked *.aip.so aip.so;
    # if ($invalid_referer) {
    #     return 403;
    # }

    # 产品演示图片（公开访问）
    location ~ ^/([^/]+)/images/ {
        # 缓存配置：30天
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # 支持Range请求
        add_header Accept-Ranges bytes;
        
        try_files $uri $uri/ =404;
    }

    # 产品缩略图（公开访问）
    location ~ ^/([^/]+)/images/\d+/ {
        # 缓存配置：30天
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        try_files $uri $uri/ =404;
    }

    # 注意：用户上传文件（upload目录）不在store中
    # upload目录由主项目后端管理，不在此静态服务中

    # 认证端点（示例）
    # location = /auth {
    #     internal;
    #     proxy_pass http://backend:5000/api/auth/verify;
    #     proxy_pass_request_body off;
    #     proxy_set_header Content-Length "";
    #     proxy_set_header X-Original-URI $request_uri;
    # }

    # 图片文件缓存配置
    location ~* \.(webp|jpg|jpeg|png|gif|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Accept-Ranges bytes;
        
        # 开启sendfile
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        try_files $uri $uri/ =404;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Nginx状态（用于监控）
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }

    # 默认location
    location / {
        try_files $uri $uri/ =404;
    }

    # 自定义错误页面
    error_page 404 /404.html;
    location = /404.html {
        internal;
        return 404 '{"error": "Not Found"}';
        add_header Content-Type application/json;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        internal;
        return 500 '{"error": "Internal Server Error"}';
        add_header Content-Type application/json;
    }
}

# 配置说明：
# 
# 1. SSL证书路径需要根据实际情况修改
# 2. root路径需要指向实际的store目录
# 3. 日志路径需要确保目录存在且可写
# 4. 限流参数可根据实际流量调整
# 5. 认证逻辑需要根据实际需求实现
# 6. 防盗链配置可根据需要启用
# 
# 启用配置：
# sudo ln -s /etc/nginx/sites-available/static-aipso /etc/nginx/sites-enabled/
# sudo nginx -t
# sudo systemctl reload nginx
